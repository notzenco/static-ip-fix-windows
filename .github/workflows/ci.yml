name: CI & Release

on:
  # 1) Validate all PRs into main
  pull_request:
    branches: [main]

  # 2) Run on pushes to main (for sanity CI) and on version tags (for releases)
  push:
    branches: [main]
    tags:
      - "v*" # tags like v1.2.3, v1.2.3-alpha.1, etc.

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure (CMake)
        run: cmake -S . -B build -G "Visual Studio 17 2022" -A x64

      - name: Build (Release)
        run: cmake --build build --config Release

      - name: Test
        run: |
          cmake --build build --config Release --target test_utils
          .\build\bin\test_utils.exe

      # Always upload on any run so tag pushes can reuse the binary
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: static-ip-fix-${{ github.sha }}
          path: build/bin/static-ip-fix.exe

  release:
    # Only run this job when the workflow was triggered by a version tag
    if: startsWith(github.ref, 'refs/tags/v')
    needs: build
    runs-on: ubuntu-latest

    # Needed so we can create a GitHub Release
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: static-ip-fix-${{ github.sha }}

      - name: Make script executable
        run: chmod +x .github/scripts/version-manager.sh

      - name: Extract release notes from changelog
        id: notes
        run: |
          VERSION="${{ github.ref_name }}"
          NOTES=$(.github/scripts/version-manager.sh extract-notes "$VERSION")
          # Write to file for the release action
          echo "$NOTES" > release_notes.md
          # Also output for debugging
          echo "Release notes for $VERSION:"
          echo "$NOTES"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body_path: release_notes.md
          files: static-ip-fix.exe
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
